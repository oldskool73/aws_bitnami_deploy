#!/bin/sh
set -e
# set -x

WORKPATH=/app
# live location
LIVEPATH=${WORKPATH}/live
# stage location
STAGEPATH=${WORKPATH}/stage
# git checkout location
GIT_WORK_TREE=${STAGEPATH}

export GIT_WORK_TREE
export LIVEPATH
export STAGEPATH

# cleanup prev checkout
rm -rf ${GIT_WORK_TREE}
mkdir -p ${GIT_WORK_TREE}

# checkout
git checkout -f

# run any user scripts
echo "running deploy scripts..."
for each in ${STAGEPATH}/deploy/scripts/*.sh;
do
    bash $each;
done;

# swap with live app
mv ${LIVEPATH} ${LIVEPATH}.bak
mv ${GIT_WORK_TREE} ${LIVEPATH}
rm -rf ${LIVEPATH}.bak

echo "** update complete **"
